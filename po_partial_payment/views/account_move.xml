<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <record id="view_move_form_advance_inherit" model="ir.ui.view">
        <field name="name">view_move_form_advance_inherit</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <xpath expr="//header" position="inside">
                <button name="action_reconcile_lines" type="object" class="oe_stat_button" string="Reconcile"
                        attrs="{'invisible': [('state', '!=', 'posted')]}"
                        invisible="context.get('display_field', True)"/>
            </xpath>

            <xpath expr="//field[@name='ref']" position="before">
                <field name="partner_id" options="{'no_open': True, 'no_create': True}"
                       invisible="context.get('display_field', True)"  attrs="{'readonly': [('posted_before', '=', True)]}"/>
                <field name="is_advance" invisible="context.get('display_field', True)"/>
                <field name="pending_amt" invisible="1"/>
            </xpath>

            <xpath expr="//div[@name='journal_div']" position="after">
                <field name="custom_payment_type" invisible="1"/>
                <field name="adv_pending_amt" invisible="1"/>
                <field name="adv_pay_amt" invisible="context.get('display_field', True)"
                       attrs="{'readonly': [('state', 'in', ('posted', 'cancel'))]}"/>
                <field name="payment_method_line_id" options="{'no_create': True, 'no_edit': True, 'no_open': True}" invisible="context.get('display_field', True)"
                       attrs="{'readonly': [('state', 'in', ('posted', 'cancel'))]}" required="1"/>
                <field name="available_payment_method_line_ids" options="{'no_create': True, 'no_edit': True}" invisible="1"/>
            </xpath>

            <xpath expr="//field[@name='line_ids']//tree/field[@name='account_id']" position="after">
                <field name="is_os_line" invisible="1" />
            </xpath>

            <xpath expr="//notebook/page[last()]" position="after">
                 <page string="Reconcile" attrs="{'invisible': [('state', '!=', 'posted')]}" invisible="context.get('display_field', True)">
                        <field name="partial_lines" context="{'default_partner_id': partner_id, 'default_entry_id': active_id}">
                            <tree editable="bottom" >
                                <field name="payment_id" invisible="1"/>
                                <field name="entry_id"  invisible="1" />
                                <field name="reconciled_id" invisible="1"/>
                                <field name="partner_id"  invisible="1"/>
                                <field name="payment_line" options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"
                                       domain="[('move_id','=', parent.id), ('account_internal_type', 'in', ('payable', 'receivable')),('partner_id', '=', partner_id)]" />
                                <field name="move_id" option="{'no_create': True, 'no_edit': True, 'no_open': True}" attrs="{'readonly': [('reconciled_id', '!=', False)]}" options="{'no_create': True, 'no_create_edit': True}"/>
                                <field name="move_amt" force_save="1" />
                                <field name="residual_amount" force_save="1"/>
                                <field name="amount" attrs="{'readonly': [('reconciled_id', '!=', False)]}" sum="Total Amount"/>
                                <button name="button_undo_reconciliation" type="object" attrs="{'invisible': [('reconciled_id', '=', False)]}" string="Revert reconciliation" icon="fa-undo"/>
                            </tree>
                        </field>
                 </page>

                <page string="Advances" invisible="context.get('display_field', True)" attrs="{'invisible': ['|', ('is_advance', '=', False), ('partner_id', '=', False)]}">
                        <field name="advance_ids" context="{'default_partner_id': partner_id}">
                            <tree editable="bottom">
                                <field name="move_id" invisible="1"/>
                                <field name="sale_id" domain="[('partner_id', '=', partner_id)]" attrs="{'column_invisible': [('parent.custom_payment_type', '!=', 'inbound')], 'required': [('parent.custom_payment_type', '=', 'inbound')]}" options="{'no_create': True, 'no_edit': True}"/>
                                <field name="purchase_id" domain="[('partner_id', '=', partner_id)]" attrs="{'column_invisible': [('parent.custom_payment_type', '!=', 'outbound')], 'required': [('parent.custom_payment_type', '=', 'inbound')]}" options="{'no_create': True, 'no_edit': True}"/>
                                <field name="partner_id" readonly="1" force_save="1"/>
                                <field name="payment_terms" force_save="1"/>
                                <field name="order_amount" force_save="1"/>
                                <field name="advance_amount" />
                            </tree>
                        </field>
                 </page>
            </xpath>
        </field>
    </record>

    <record id="action_pay_payments" model="ir.actions.act_window">
        <field name="name">Pay Payments</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'default_move_type': 'entry', 'default_custom_payment_type': 'outbound', 'display_field': False}</field>
        <field name="domain">[('custom_payment_type', '=', 'outbound')]</field>
    </record>

    <record id="action_bank_receipts" model="ir.actions.act_window">
        <field name="name">Bank Receipts</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'default_move_type': 'entry', 'default_custom_payment_type': 'inbound', 'display_field': False}</field>
        <field name="domain">[('custom_payment_type', '=', 'inbound')]</field>
    </record>

    <menuitem id="menu_pay_payments" name="Bank Receipts" parent="account.menu_finance_receivables" sequence="4" action="action_bank_receipts" />
    <menuitem id="menu_bank_receipts" name="Pay Payments" parent="account.menu_finance_payables" sequence="4" action="action_pay_payments" />


    <record id="sale_order_advance_form_view" model="ir.ui.view">
        <field name="name">Sale_order_Advance_Payment_Form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button name="create_advance_payment" string="Advance Payment"  type="object" attrs="{'invisible': [('state', '!=', 'sale')]}"/>
            </xpath>
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="view_advance_payment" type="object" class="oe_stat_button" icon="fa-pencil-square-o" attrs="{'invisible': [('state', '!=', 'sale')]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Advance</span>
                        <span class="o_stat_text">Payment</span>
                    </div>
                </button>
            </xpath>
        </field>
    </record>

     <record model="ir.ui.view" id="sale_order_tree_view_advance">
        <field name="name">Sale Order Advance Payment Tree</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="inside">
                <header>
                    <button name="create_advance_payment" string="Advance Payment" class="btn btn-dark" type="object"/>
                </header>
            </xpath>
        </field>
    </record>

    <record id="purchase_order_advance_form_view" model="ir.ui.view">
        <field name="name">Purchase order Advance Payment Form</field>
        <field name="model">purchase.order</field>
        <field name="inherit_id" ref="purchase.purchase_order_form"/>
        <field name="arch" type="xml">

            <xpath expr="//header" position="inside">
                <button name="create_advance_payment" string="Advance Payment"  type="object" attrs="{'invisible': [('state', '!=', 'purchase')]}"/>
            </xpath>

            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="view_advance_payment" type="object" class="oe_stat_button" icon="fa-pencil-square-o" attrs="{'invisible': [('state', '!=', 'purchase')]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Advance</span>
                        <span class="o_stat_text">Payment</span>
                    </div>
                </button>
            </xpath>
        </field>
    </record>

     <record model="ir.ui.view" id="purchase_order_tree_view_advance">
        <field name="name">Purchase Order Advance Payment Tree</field>
        <field name="model">purchase.order</field>
        <field name="inherit_id" ref="purchase.purchase_order_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="inside">
                <header>
                    <button name="create_advance_payment" string="Advance Payment" class="btn btn-dark" type="object"/>
                </header>
            </xpath>
        </field>
    </record>



</odoo>